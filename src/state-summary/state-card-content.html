<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="state-card-climate.html">
<link rel="import" href="state-card-configurator.html">
<link rel="import" href="state-card-cover.html">
<link rel="import" href="state-card-display.html">
<link rel="import" href="state-card-input_select.html">
<link rel="import" href="state-card-input_slider.html">
<link rel="import" href="state-card-media_player.html">
<link rel="import" href="state-card-scene.html">
<link rel="import" href="state-card-script.html">
<link rel="import" href="state-card-toggle.html">
<link rel="import" href="state-card-weblink.html">
<link rel="import" href="../util/hass-behavior.html">

<script>
Polymer({
  is: 'state-card-content',

  behaviors: [window.hassBehavior],

  properties: {
    hass: {
      type: Object,
    },

    inDialog: {
      type: Boolean,
      value: false,
    },

    stateObj: {
      type: Object,
    },

    customUis: {
      type: Object,
      bindNuclear: function (hass) {
        return hass.customUiGetters.customUi;
      },
    },
  },

  observers: [
    'inputChanged(hass, inDialog, stateObj, customUis)',
  ],

  _isLoaded: function (name) {
    var elem = document.createElement(name);
    // If Polymer was already loaded for <name> - it replaced the constructor.
    return (elem.constructor !== HTMLElement);
  },

  _loadCustomUi: function (customUis, stateType) {
    var customUi = customUis.get(stateType);
    var isLoaded = this._isLoaded('STATE-CARD-' + stateType.toUpperCase());
    if (!isLoaded && !customUi) {
      /* eslint-disable no-console */
      console.error('Custom ui for %s is unknown.');
      /* eslint-enable no-console */
      return undefined;
    }
    // If Polymer component for the required element is not loaded try to load it.
    // Don't try to load unconditionally because it cause onflict between vulcanized
    // and non-vulacanized versions.
    if (!isLoaded) {
      this.importHref(
          customUi.get('url'),
          function () {},
          /* eslint-disable no-console */
          function () { console.error('Error loading %s from %s', stateType, customUi.get('url')); },
          /* eslint-enable no-console */

          true);
    }

    return customUi ? customUi.get('config') : undefined;
  },

  inputChanged: function (hass, inDialog, stateObj, customUis) {
    var stateType;
    var config;
    if (!stateObj) return;
    if (stateObj.state !== 'unavailable' && 'custom_ui_card' in stateObj.attributes) {
      stateType = stateObj.attributes.custom_ui_card;
      config = this._loadCustomUi(customUis, stateType);
    } else {
      stateType = window.hassUtil.stateCardType(hass, stateObj);
    }
    window.hassUtil.dynamicContentUpdater(
      this,
      ('STATE-CARD-' + stateType.toUpperCase()),
      {
        hass: hass,
        stateObj: stateObj,
        inDialog: inDialog,
        config: config || new Map(),
      });
  },
});
</script>
